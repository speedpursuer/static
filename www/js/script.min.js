angular.module("app","ionic app.controllers app.routes app.services app.directives pouchdb ImgCache ngCordova".split(" ")).config(["$ionicConfigProvider","ImgCacheProvider",function(a,b){b.setOptions({usePersistentCache:!0,useDataURI:!0,skipURIencoding:!0});a.views.swipeBackEnabled(!1);a.scrolling.jsScrolling(!1)}]).run(["$ionicPlatform","$cordovaStatusbar","$rootScope",function(a,b,c){a.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!1),
cordova.plugins.Keyboard.disableScroll(!0));window.StatusBar&&StatusBar.styleDefault()});c.$on("$stateChangeError",function(a,c,b,g,q,t){console.log("stateChangeError");a.preventDefault()})}]);
angular.module("app.routes",[]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/root");a.state("root",{url:"/root",controller:"RootCtrl",templateUrl:"templates/root.html"}).state("tabsController",{url:"/tab","abstract":!0,templateUrl:"templates/tabsController.html",resolve:{init:["DBService",function(a){return a.init()}]}}).state("tabsController.stars",{url:"/stars",resolve:{stars:["DBService","init",function(a,b){return a.dataFetcher().getStars()}]},views:{tab1:{templateUrl:"templates/stars.html",
controller:"StarsCtrl"}}}).state("tabsController.moves",{url:"/moves/:playerID, :playerName",resolve:{moves:["$stateParams","DBService",function(a,b){return b.dataFetcher().getMovesByPlayer(a.playerID)}]},views:{tab1:{controller:"MovesCtrl",templateUrl:"templates/moves.html"}}}).state("tabsController.clips",{url:"/clips/:playerID, :moveName, :moveID",resolve:{clips:["$stateParams","DBService",function(a,b){return b.pagination().clips().init(a.playerID,a.moveID)}]},views:{tab1:{controller:"ClipsCtrl",
templateUrl:"templates/clips.html"}}}).state("tabsController.players",{url:"/players",views:{tab2:{controller:"PlayersCtrl",templateUrl:"templates/players.html"}}}).state("tabsController.tab2Moves",{url:"/moves2/:playerID, :playerName",resolve:{moves:["$stateParams","DBService",function(a,b){return b.dataFetcher().getMovesByPlayer(a.playerID)}]},views:{tab2:{controller:"Tab2MovesCtrl",templateUrl:"templates/moves.html"}}}).state("tabsController.tab2Clips",{url:"/clips2/:playerID, :moveName, :moveID",
resolve:{clips:["$stateParams","DBService",function(a,b){return b.pagination().clips().init(a.playerID,a.moveID)}]},views:{tab2:{controller:"ClipsCtrl",templateUrl:"templates/clips.html"}}}).state("tabsController.favorite",{url:"/favorite",views:{tab4:{controller:"FavorateCtrl",templateUrl:"templates/favorite.html"}}})}]);
angular.module("app.services",[]).factory("DBService",["$q","pouchdb","ErrorService","FileCacheService",function(a,b,c,d){function k(){return d.cacheFiles(h.moveList)}function l(){var m=a.defer(),f=h.getPlayerList()[0]._id;w.getMovesByPlayer(f).then(function(a){var p=a[0]._id;v.clips().init(f,p).then(function(a){a={player:f,move:p};v.favorite().init(a).then(function(a){m.resolve("Index verified")})["catch"](function(a){m.reject(a)})})["catch"](function(a){m.reject(a)})})["catch"](function(a){m.reject(a)});
return m.promise}function g(){c.showAlert("\u65e0\u6cd5\u5b8c\u6210\u5b89\u88c5","\u8bf7\u786e\u8ba4\u4e92\u8054\u7f51\u8fde\u63a5\u3002",!0)}function q(){return v.favorite().init()}function t(){return w.getMoves()}function u(){var m=a.defer();e.query("views/players",{reduce:!0,group:!0,group_level:2}).then(function(a){var b=[],p=[];for(i in a.rows)b.push(a.rows[i].key),p.push(a.rows[i].value);e.allDocs({include_docs:!0,keys:b}).then(function(a){for(i in a.rows)a.rows[i].doc.clipQty=p[i];a=a.rows.map(function(a){return a.doc});
h.setPlayerList(a);m.resolve("All players retrieved")})["catch"](function(a){m.reject(a)})})["catch"](function(a){m.reject(a)});return m.promise}function x(){return e.replicate.from(r.remoteURL+r.dbName)}function y(){return e.put({_id:"_design/views",views:{players:{map:function(a){var f,b;if(a.move_name&&a.clip_player)for(b in a.clip_player)f=a.clip_player[b],emit(f,b)}.toString(),reduce:"_count"},moves:{map:function(a){var f,b;if(a.move_name&&a.clip_player&&a.image)for(b in a.clip_player)f=a.clip_player[b],
emit([f,a.move_name,a.image,a.desc,a._id],1)}.toString(),reduce:function(a,f,b){return sum(f)}.toString()},clips:{map:function(a){var f,b;if(a.move_name&&a.clip_player)for(b in a.clip_player)f=a.clip_player[b],emit([f,a._id,b],b)}.toString()},local:{map:function(a){"clip"===a.type&&emit(a._id,{_id:a.local,desc:a.desc,name:a.name,image:a.image,local:a.local})}.toString()},favorite:{map:function(a){"local"===a.type&&emit([a.favorite,a.timestamp],{_id:a.clip,thumb:a.thumb,timestamp:a.timestamp})}.toString()},
favorite_player_move:{map:function(a){"local"===a.type&&emit([a.favorite,a.player,a.move,a.timestamp],{_id:a.clip,thumb:a.thumb,timestamp:a.timestamp})}.toString()},favorite_player:{map:function(a){"local"===a.type&&emit([a.favorite,a.player,a.timestamp],{_id:a.clip,thumb:a.thumb,timestamp:a.timestamp})}.toString()},favorite_move:{map:function(a){"local"===a.type&&emit([a.favorite,a.move,a.timestamp],{_id:a.clip,thumb:a.thumb,timestamp:a.timestamp})}.toString()}}})}function z(){return e.createIndex({index:{fields:["type"]}})}
function A(){return e.put({_id:"DBInstalled",status:"completed"})}var n={},r={dbName:"cliplay",remoteURL:dbString?dbString:"http://admin:12341234@localhost:5984/",dbAdapter:"websql",network_err:{title:"\u65e0\u6cd5\u83b7\u53d6\u6700\u65b0\u6570\u636e",desc:"\u6ca1\u6709\u53ef\u4f7f\u7528\u7684\u4e92\u8054\u7f51\u8fde\u63a5\u3002"}},e=b.create(r.dbName,{adapter:r.dbAdapter});b="undefined"!==typeof device&&-1!==device.model.indexOf("iPad")?!0:!1;n.list=function(){return h};n.dataFetcher=function(){return w};
n.pagination=function(){return v};n.remoteDB=function(){return B};var h={favoriteList:[],playerList:[],moveList:[],clipList:[],setClipList:function(a){var b=this.clipList;b.push.apply(b,a)},resetClipList:function(){this.clipList.length=0},getClipList:function(){return this.clipList},setMoveList:function(a){this.moveList.length=0;var b=this.moveList;b.push.apply(b,a)},getMoveList:function(){return this.moveList},setPlayerList:function(a){this.playerList.length=0;var b=this.playerList;b.push.apply(b,
a)},getPlayerList:function(){return this.playerList},setFavoriteList:function(a){var b=this.favoriteList;b.push.apply(b,a)},resetFavoriteList:function(){this.favoriteList.length=0},getFavoriteList:function(){return this.favoriteList},addFavoriteToList:function(a,b){for(var d=0;d<this.favoriteList.length;d++)if(this.favoriteList[d]._id==a)return;var p=this;e.get(a).then(function(a){a.thumb=b;a.favorite=!0;p.favoriteList.unshift(a)})},removeFavoriteFromList:function(a){for(var b=0;b<this.favoriteList.length;b++)if(this.favoriteList[b]._id==
a){this.favoriteList.splice(b,1);break}},getMoves:function(){return e.find({selector:{type:"move"}})},getAllPlayers:function(){return u()}},w={getStars:function(){return e.find({selector:{type:"player",star:!0}})},getMoves:function(){var b=a.defer();e.find({selector:{type:"move"},fields:["_id","move_name","image"]}).then(function(a){h.setMoveList(a.docs);b.resolve("Moves retrieved")})["catch"](function(){b.reject("Moves not retrieved")});return b.promise},getMovesByPlayer:function(b){var f=a.defer();
e.query("views/moves",{startkey:[b],endkey:[b,{}],reduce:!0,group:!0}).then(function(a){var b=[];for(i in a.rows)b.push({_id:a.rows[i].key[4],name:a.rows[i].key[1],image:a.rows[i].key[2],desc:a.rows[i].key[3],clipQty:a.rows[i].value});f.resolve(b)})["catch"](function(a){f.reject(a)});return f.promise}},v={clips:function(){return this.clipsPg},favorite:function(){return this.favoritePg},clipsPg:{options:{},end:{noMore:!0},limit:b?12:7,descending:!0,init:function(a,b){this.options={descending:this.descending,
limit:this.limit,endkey:[a,b],startkey:[a,b,{}],reduce:!0,group:!0};h.resetClipList();this.end.noMore=!0;return this.getClips()},more:function(a){this.getClips()["catch"](function(){c.showAlert("\u65e0\u6cd5\u83b7\u53d6\u6570\u636e")})["finally"](function(){a&&a()})},hasNoMore:function(){return this.end},getClips:function(){var b=a.defer(),f=this,d=f.options;e.query("views/clips",d).then(function(a){if(a&&0<a.rows.length){d.startkey=a.rows[a.rows.length-1].key;var c=[];for(i in a.rows)c.push(a.rows[i].value);
e.query("views/local",{include_docs:!0,keys:c}).then(function(a){a=a.rows.map(function(a){var b="",m=!1;a.doc&&(b=a.doc.thumb,m=a.doc.favorite);return{_id:a.id,name:a.value.name,desc:a.value.desc,image:a.value.image,local:a.value.local,thumb:b,favorite:m}});f.end.noMore=a.length<f.limit?!0:!1;a.length==f.limit&&a.splice(-1,1);h.setClipList(a);b.resolve("More data fetched")})["catch"](function(a){b.reject(a)})}else f.end.noMore=!0,b.resolve("No more data")})["catch"](function(a){b.reject(a)});return b.promise}},
favoritePg:{options:{},end:{noMore:!0},limit:b?12:7,view:"",descending:!0,init:function(){this.view="favorite";this.options={descending:this.descending,limit:this.limit,include_docs:!0,endkey:[!0],startkey:[!0,{}]};this.end.noMore=!0;h.resetFavoriteList();return this.getFavorite()},search:function(a,b){a||(a={});h.resetFavoriteList();a.player&&a.move?(this.view="favorite_player_move",this.options={descending:this.descending,limit:this.limit,include_docs:!0,endkey:[!0,a.player,a.move],startkey:[!0,
a.player,a.move,{}]}):a.player?(this.view="favorite_player",this.options={descending:this.descending,limit:this.limit,include_docs:!0,endkey:[!0,a.player],startkey:[!0,a.player,{}]}):a.move?(this.view="favorite_move",this.options={descending:this.descending,limit:this.limit,include_docs:!0,endkey:[!0,a.move],startkey:[!0,a.move,{}]}):(this.view="favorite",this.options={descending:this.descending,limit:this.limit,include_docs:!0,endkey:[!0],startkey:[!0,{}]});this.end.noMore=!0;this.more(b)},more:function(a){this.getFavorite()["catch"](function(){c.showAlert("\u65e0\u6cd5\u83b7\u53d6\u6570\u636e")})["finally"](function(){a&&
a()})},hasNoMore:function(){return this.end},needLoad:function(){return!this.hasNoMore().noMore&&h.getFavoriteList().length<this.limit?!0:!1},getFavorite:function(){var b=a.defer(),d=this,c=d.options;e.query("views/"+d.view,c).then(function(a){a&&0<a.rows.length?(c.startkey=a.rows[a.rows.length-1].key,d.end.noMore=a.rows.length<d.limit?!0:!1,a.rows.length==d.limit&&a.rows.splice(-1,1),a=a.rows.map(function(a){return{_id:a.doc._id,name:a.doc.name,desc:a.doc.desc,image:a.doc.image,thumb:a.value.thumb,
favorite:a.key[0],local:a.id,player:a.doc.player,move:a.doc.move,timestamp:a.value.timestamp}}),h.setFavoriteList(a),b.resolve("Favorite retrieved")):(d.end.noMore=!0,b.resolve("No more data"))})["catch"](function(a){b.reject(a)});return b.promise}}},B={syncRemote:function(a){x().then(function(a){0<a.docs_written&&(u(),t())})["catch"](function(a){c.showAlert("\u65e0\u6cd5\u540c\u6b65\u6570\u636e","\u8bf7\u786e\u8ba4\u4e92\u8054\u7f51\u8fde\u63a5\u3002")})["finally"](function(){a&&a()})},change:function(){e.changes({limit:10,
since:73}).then(function(a){console.log(a)})["catch"](function(a){console.log(a)})}};n.put=function(a){return e.put(a)};n.updateBoth=function(a,b,d){e.get(a).then(function(d){e.get(d.local).then(function(a){var c=new Date;a.thumb=d.image+".jpg";a.favorite=b;a.timestamp=""+c.getTime();e.put(a)})["catch"](function(){var c={_id:d.local,type:"local",favorite:b,thumb:d.image+".jpg",clip:a,player:d.player,move:d.move,timestamp:""+(new Date).getTime()};e.put(c)});b?h.addFavoriteToList(a,d.image+".jpg"):
h.removeFavoriteFromList(a)});(function(d){if(d&&0<d.length)for(i in d)if(d[i]._id==a){d[i].thumb=d[i].image+".jpg";d[i].favorite=b;break}})(d)};n.updateFavorite=function(a,b,d){e.get(b).then(function(b){b.favorite=d;b.timestamp=""+(new Date).getTime();e.put(b);d?h.addFavoriteToList(a,b.thumb):h.removeFavoriteFromList(a)})["catch"](function(){e.get(a).then(function(c){c={_id:b,type:"local",favorite:d,thumb:"",clip:a,player:c.player,move:c.move,timestamp:""+(new Date).getTime()};e.put(c);h.addFavoriteToList(a,
"")})})};n.updateThumb=function(a,b){var d=function(b){if(b&&0<b.length)for(i in b)if(b[i]._id==a){b[i].thumb=b[i].image+".jpg";break}};e.get(a).then(function(b){e.get(b.local).then(function(a){a.thumb=b.image+".jpg";e.put(a)})["catch"](function(){e.put({_id:b.local,type:"local",favorite:!1,thumb:b.image+".jpg",clip:a,player:b.player,move:b.move})})});d(h.getFavoriteList());d(b)};n.init=function(){var b=a.defer();e.get("DBInstalled").then(function(){x().then(function(){u().then(t).then(q).then(function(){b.resolve("DB Existed")})["catch"](function(a){g();
b.reject("Err in getting init data: "+a)})})["catch"](function(){u().then(t).then(q).then(function(){b.resolve("DB Existed");c.showAlert(r.network_err.title,r.network_err.desc)})["catch"](function(a){g();b.reject("Err in getting init data: "+a)})})})["catch"](function(){x().then(y).then(z).then(u).then(t).then(q).then(l).then(k).then(A).then(function(){b.resolve("DB Created")})["catch"](function(a){console.log(a);g();b.reject("Err in creating DB"+a)})});return b.promise};return n}]).factory("ImgCacheService",
["$q","ImgCache",function(a,b){function c(a,c){b.isCached(c,function(l,g){g?b.useCachedFileWithSource(a,c):b.cacheFile(c,function(){b.useCachedFileWithSource(a,c)})})}return{cacheImg:function(a){var b=new Image;c(b,a)}}}]).factory("FileCacheService",["$q","ImgCache",function(a,b){function c(d){var c=a.defer();b.$promise.then(function(){b.cacheFile(d,function(){c.resolve("file downloaded")},function(){c.resolve("file not downloaded")})});return c.promise}return{download:function(d){var c=a.defer();
b.$promise.then(function(){b.cacheFile(d,function(){b.getCachedFileURL(d,function(a,b){c.resolve(b)})},function(){c.reject("download file error")},function(a){$("#progress").val(a.loaded/a.total)})});return c.promise},cacheFiles:function(b){var k=[];angular.forEach(b,function(a){a=c(a.image);k.push(a)});return a.all(k)}}}]).factory("NativeService",function(){var a={},b=function(a){},c=function(a){console.log(a)};a.playAnimation=function(a,k,l){cordova.exec(b,c,"MyHybridPlugin","playClip",[a,k?"true":
"false",l?"true":"false"])};a.showMessage=function(a,k,l){var g="false";l&&(g="true");cordova.exec(b,c,"MyHybridPlugin","showMessage",[a,k,g])};return a}).factory("ErrorService",["$rootScope","$cordovaSplashscreen","$ionicPopup","$ionicLoading","$timeout","NativeService",function(a,b,c,d,k,l){var g={showSplashScreen:function(){b.show()},hideSplashScreen:function(){k(function(){b.hide()},500)},showAlert:function(a,b,c){l.showMessage(a,b?b:"\u8bf7\u7a0d\u540e\u91cd\u8bd5",c)},showDownLoader:function(){d.show({template:'<span>Downloading...</span><progress max="1" id="progress"></progress>',
hideOnStateChange:!0})},showLoader:function(){d.show({template:'<ion-spinner icon="crescent" class="spinner-assertive"></ion-spinner>',hideOnStateChange:!0})},hideLoader:function(a){d.hide();a&&g.showAlert(a)}};return g}]);
angular.module("app.controllers",[]).controller("RootCtrl",["$scope","$state","$timeout",function(a,b,c){function d(){b.go("tabsController.favorite").then(function(a){c(function(){b.go("tabsController.players").then(function(a){c(function(){b.go("tabsController.stars")})})})})}d();a.retry=function(){d()}}]).controller("StarsCtrl",["$scope","$ionicSlideBoxDelegate","$state","ErrorService","stars",function(a,b,c,d,k){a.stars=k.docs;b.update();b.slide(0);d.hideSplashScreen();a.showMoves=function(a,b){c.go("tabsController.moves",
{playerID:a,playerName:b})}}]).controller("ClipsCtrl",["$scope","$stateParams","$ionicListDelegate","DBService","NativeService",function(a,b,c,d,k){function l(b){d.updateFavorite(a.clips[b]._id,a.clips[b].local,!a.clips[b].favorite);a.clips[b].favorite=!a.clips[b].favorite}a.clips=d.list().getClipList();a.noMoreItemsAvailable=d.pagination().clips().hasNoMore();a.listCanSwipe=!0;a.playerName=b.playerName;a.moveName=b.moveName;a.playingClipIndex="";a.loadMore=function(){d.pagination().clips().more(function(){a.$broadcast("scroll.infiniteScrollComplete")})};
a.play=function(b){a.playingClipIndex=b;k.playAnimation(a.clips[b].image,a.clips[b].favorite,!0)};a.updateFavorite=function(a){c.closeOptionButtons();l(a)};a.updateFavoriteFromNative=function(){l(a.playingClipIndex)};a.updateThumbFromNative=function(b){"download"!==b&&a.clips[a.playingClipIndex].thumb||d.updateThumb(a.clips[a.playingClipIndex]._id,a.clips)};a.updateBothFromNative=function(b){"download"!==b&&a.clips[a.playingClipIndex].thumb?l(a.playingClipIndex):d.updateBoth(a.clips[a.playingClipIndex]._id,
!a.clips[a.playingClipIndex].favorite,a.clips)}}]).controller("FavorateCtrl",["$scope","$state","$ionicScrollDelegate","$ionicListDelegate","$ionicPopover","ErrorService","DBService","NativeService",function(a,b,c,d,k,l,g,q){a.listCanSwipe=!0;a.playingClipIndex="";a.clips=g.list().getFavoriteList();a.noMoreItemsAvailable=g.pagination().favorite().hasNoMore();a.data={players:g.list().getPlayerList(),moves:g.list().getMoveList()};a.search={selected_player:"",selected_move:"",by_player:"",by_move:""};
k.fromTemplateUrl("templates/popover.html",{scope:a}).then(function(b){a.popover=b});a.openPopover=function(b){a.search.by_player=a.search.selected_player;a.search.by_move=a.search.selected_move;a.popover.show(b)};a.filter=function(){l.showLoader();c.scrollTop();var b={player:a.search.by_player,move:a.search.by_move};a.search.selected_player=a.search.by_player;a.search.selected_move=a.search.by_move;g.pagination().favorite().search(b,function(){l.hideLoader()});a.popover.hide()};a.loadMore=function(){g.pagination().favorite().more(function(){a.$broadcast("scroll.infiniteScrollComplete")})};
a.play=function(b){a.playingClipIndex=b;q.playAnimation(a.clips[b].image,a.clips[b].favorite,!1)};a.removeFavorite=function(b){d.closeOptionButtons();g.updateFavorite(a.clips[b]._id,a.clips[b].local,!1);g.pagination().favorite().needLoad()&&a.loadMore()};a.updateThumbFromNative=function(b){"download"!==b&&a.clips[a.playingClipIndex].thumb||g.updateThumb(a.clips[a.playingClipIndex]._id,null)}}]).controller("PlayersCtrl",["$scope","$state","DBService",function(a,b,c){a.players=c.list().getPlayerList();
a.doRefresh=function(){c.remoteDB().syncRemote(function(){a.$broadcast("scroll.refreshComplete")})};a.showMoves=function(a,c){b.go("tabsController.tab2Moves",{playerID:a,playerName:c})}}]).controller("MovesCtrl",["$scope","$state","$stateParams","moves",function(a,b,c,d){a.moves=d;a.playerName=c.playerName;a.showClips=function(a,d){b.go("tabsController.clips",{playerID:c.playerID,moveName:a,moveID:d})}}]).controller("Tab2MovesCtrl",["$scope","$state","$stateParams","moves",function(a,b,c,d){a.moves=
d;a.playerName=c.playerName;a.showClips=function(a,d){b.go("tabsController.tab2Clips",{playerID:c.playerID,moveName:a,moveID:d})}}]);
angular.module("app.directives",[]).directive("blankDirective",[function(){}]).directive("backImg",function(){return function(a,b,c){b.css({"background-image":"url("+c.backImg+")"})}}).directive("hideTabs",["$rootScope",function(a){return{restrict:"A",link:function(b,c,d){b.$on("$ionicView.beforeEnter",function(){b.$watch(d.hideTabs,function(b){a.hideTabs=b})});b.$on("$ionicView.beforeLeave",function(){a.hideTabs=!1})}}}]);var dbString="";
function startForIOS(){cordova.exec(function(a){dbString=a;angular.bootstrap(document.body,["app"])},function(a){console.log(a)},"MyHybridPlugin","dbString")}function test(){angular.element(document.getElementById("ClipsScopeID")).injector().get("DBService").list().getPlayerList()}
function updateClip(a,b,c){"clip"===c?(c=angular.element(document.getElementById("ClipsScopeID")).scope(),""!==b?"favorite"===a?c.updateBothFromNative(b):c.updateThumbFromNative(b):"favorite"===a&&c.updateFavoriteFromNative()):""!==b&&(c=angular.element(document.getElementById("FavoriteScopeID")).scope(),c.updateThumbFromNative(b))}function retryInstall(){angular.element(document.getElementById("RootScopeID")).scope().retry()}
angular.element(document).ready(function(){window.cordova?(console.log("Running in Cordova, will bootstrap AngularJS once 'deviceready' event fires."),document.addEventListener("deviceready",function(){console.log("Deviceready event has fired, bootstrapping AngularJS.");startForIOS()},!1)):(console.log("Running in browser, bootstrapping AngularJS now."),angular.bootstrap(document.body,["app"]))});